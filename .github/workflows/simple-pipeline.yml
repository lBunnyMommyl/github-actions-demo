# .github/workflows/simple-pipeline.yml
name: Simple CI/CD Demo

on:
  push:
    branches: [main]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  # –≠—Ç–∞–ø 1: –°–±–æ—Ä–∫–∞
  build:
    runs-on: self-hosted  # –ò–õ–ò ubuntu-latest –¥–ª—è GitHub-hosted
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        run: |
          echo "üìÅ –§–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ:"
          ls -la
          echo ""
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

      - name: üê≥ –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
        run: |
          echo "–°–æ–±–∏—Ä–∞—é Docker –æ–±—Ä–∞–∑..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ Dockerfile
          if [ -f ".github/demo-app/Dockerfile" ]; then
            docker build -t demo-app:latest .github/demo-app/
            echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω!"
            docker images | grep demo-app
          else
            echo "‚ö†Ô∏è Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π..."
            mkdir -p .github/demo-app
            cat > .github/demo-app/Dockerfile << 'EOF'
FROM alpine:3.16
RUN echo "Hello from Docker!" > /message
CMD cat /message
EOF
            docker build -t demo-app:latest .github/demo-app/
            echo "‚úÖ –î–µ–º–æ-–æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω!"
          fi

  # –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    runs-on: self-hosted
    needs: build  # –ñ–¥–µ–º —Å–±–æ—Ä–∫—É
    steps:
      - name: üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
        run: |
          echo "–ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã..."
          
          # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
          echo "1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É—é Docker –æ–±—Ä–∞–∑..."
          docker run --rm demo-app:latest || true
          
          # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
          echo ""
          echo "2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É—é –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–µ
          CONTAINER_ID=$(docker run -d --rm -p 8080:8080 demo-app:latest 2>/dev/null || echo "")
          
          if [ -n "$CONTAINER_ID" ]; then
            sleep 2  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫
            
            # –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å health (–µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä)
            echo "–ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker ps | grep demo-app
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker stop $CONTAINER_ID 2>/dev/null || true
          else
            echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–∞–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –¥–µ–º–æ)"
          fi
          
          echo ""
          echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!"

  # –≠—Ç–∞–ø 3: –î–µ–ø–ª–æ–π (–¥–µ–º–æ)
  deploy:
    runs-on: self-hosted
    needs: test  # –ñ–¥–µ–º —Ç–µ—Å—Ç—ã
    steps:
      - name: üöÄ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –æ–±—Ä–∞–∑
          docker images demo-app:latest
          
          echo ""
          echo "üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è:"
          echo "1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑ –≤ —Ñ–∞–π–ª:"
          echo "   docker save demo-app:latest -o demo-app.tar"
          echo "2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä:"
          echo "   scp demo-app.tar user@server:/path/"
          echo "3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
          echo "   docker load -i demo-app.tar"
          echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç—å:"
          echo "   docker run -d -p 8080:8080 --name myapp demo-app:latest"
          
      - name: üìä –û—Ç—á–µ—Ç
        run: |
          echo "üìà –û—Ç—á–µ—Ç –æ —Å–±–æ—Ä–∫–µ:"
          echo "=================="
          echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: Demo App"
          echo "–°—Ç–∞—Ç—É—Å: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
          echo "–í—Ä–µ–º—è: $(date)"
          echo "ID –∑–∞–ø—É—Å–∫–∞: ${{ github.run_id }}"
          echo ""
          echo "–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
          docker images --filter "reference=demo-app*"
          echo ""
          echo "üéâ –ö–æ–Ω–≤–µ–π–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
