# .github/workflows/simple-pipeline.yml
name: Simple CI/CD Demo

on:
  push:
    branches: [main]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  # Ð­Ñ‚Ð°Ð¿ 1: Ð¡Ð±Ð¾Ñ€ÐºÐ°
  build:
    runs-on: self-hosted
    steps:
      - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
        uses: actions/checkout@v4

      - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
        run: |
          echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ:"
          ls -la
          echo ""
          echo "âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð°"

      - name: ðŸ³ Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Docker Ð¾Ð±Ñ€Ð°Ð·
        run: |
          echo "Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ Docker Ð¾Ð±Ñ€Ð°Ð·..."
          docker build -t demo-app:latest .github/demo-app/
          
          echo "âœ… ÐžÐ±Ñ€Ð°Ð· ÑÐ¾Ð±Ñ€Ð°Ð½!"
          docker images demo-app

  # Ð­Ñ‚Ð°Ð¿ 2: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  test:
    runs-on: self-hosted
    needs: build  # Ð–Ð´ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ
    steps:
      - name: ðŸ§ª Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹
        run: |
          echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ñ‚ÐµÑÑ‚Ñ‹..."
          
          # Ð¢ÐµÑÑ‚ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°
          echo "1ï¸âƒ£ Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÑŽ Docker Ð¾Ð±Ñ€Ð°Ð·..."
          docker run --rm demo-app:latest python3 --version
          
          # Ð¢ÐµÑÑ‚ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          echo ""
          echo "2ï¸âƒ£ Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð² Ñ„Ð¾Ð½Ðµ
          docker run -d --name test-app -p 8080:8080 demo-app:latest
          sleep 3  # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health check
          curl -f http://localhost:8080/health || echo "âš ï¸ Health check failed"
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
          docker stop test-app
          docker rm test-app
          
          echo ""
          echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!"

  # Ð­Ñ‚Ð°Ð¿ 3: Ð”ÐµÐ¿Ð»Ð¾Ð¹ (Ð´ÐµÐ¼Ð¾)
  deploy:
    runs-on: self-hosted
    needs: test  # Ð–Ð´ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
    steps:
      - name: ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
          
          # Ð”ÐµÐ¼Ð¾: Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´ÐµÐ¿Ð»Ð¾Ñ
          echo "ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ:"
          echo "1. docker pull demo-app:latest"
          echo "2. docker-compose up -d"
          echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: curl http://server:8080/health"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.yml Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾
          cat > docker-compose.demo.yml << EOF
version: '3'
services:
  app:
    image: demo-app:latest
    ports:
      - "8080:8080"
    restart: always
EOF
          
          echo ""
          echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½ docker-compose.yml:"
          cat docker-compose.demo.yml
          
          echo ""
          echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ð´ÐµÐ¿Ð»Ð¾ÑŽ!"
          
      - name: ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚
        run: |
          echo "ðŸ“ˆ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ:"
          echo "=================="
          echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: Demo App"
          echo "Ð’ÐµÑ€ÑÐ¸Ñ: latest"
          echo "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾"
          echo "Ð’Ñ€ÐµÐ¼Ñ: $(date)"
          echo ""
          echo "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
          echo "1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ: docker-compose -f docker-compose.demo.yml up -d"
          echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸: docker-compose logs app"
          echo "3. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ: http://Ð²Ð°Ñˆ-ÑÐµÑ€Ð²ÐµÑ€:8080"
