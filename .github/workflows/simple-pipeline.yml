# .github/workflows/pipeline-with-graph.yml
name: CI/CD Pipeline with Visualization

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
  setup:
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.set-time.outputs.timestamp }}
    steps:
      - name: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        id: set-time
        run: |
          echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
        run: |
          echo "üîó –í–µ—Ç–∫–∞: ${{ github.ref }}"
          echo "üìù –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          echo "üïê –í—Ä–µ–º—è: ${{ steps.set-time.outputs.timestamp }}"

  # –≠—Ç–∞–ø 2: –õ–∏–Ω—Ç–∏–Ω–≥ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–æ —Å–±–æ—Ä–∫–æ–π)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        run: |
          echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
          find . -name "*.yml" -o -name "*.yaml" | wc -l | xargs echo "–ù–∞–π–¥–µ–Ω–æ YAML —Ñ–∞–π–ª–æ–≤:"
          echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"

  # –≠—Ç–∞–ø 3: –°–±–æ—Ä–∫–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç setup)
  build:
    needs: [setup, lint]  # ‚¨ÖÔ∏è –°–¢–†–ï–õ–û–ß–ö–ê –û–¢ setup –ò lint –ö build
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          echo "üèóÔ∏è –°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
          echo "–í–µ—Ä—Å–∏—è: ${{ needs.setup.outputs.timestamp }}"
          mkdir -p dist
          echo "Build successful" > dist/build.log
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      
      - name: üìé –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 5

  # –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–±–æ—Ä–∫–∏)
  test:
    needs: build  # ‚¨ÖÔ∏è –°–¢–†–ï–õ–û–ß–ö–ê –û–¢ build –ö test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ ${{ matrix.test-type }}
        run: |
          echo "üß™ –í—ã–ø–æ–ª–Ω—è—é ${{ matrix.test-type }} —Ç–µ—Å—Ç—ã..."
          sleep 2
          echo "‚úÖ ${{ matrix.test-type }} —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
          echo "Test passed: ${{ matrix.test-type }}" > test-${{ matrix.test-type }}.log
      
      - name: üìä –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç—ã
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.test-type }}
          path: test-*.log

  # –≠—Ç–∞–ø 5: –î–µ–ø–ª–æ–π –Ω–∞ staging (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤)
  deploy-staging:
    needs: [test]  # ‚¨ÖÔ∏è –°–¢–†–ï–õ–û–ß–ö–ê –û–¢ test –ö deploy-staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ staging
        run: |
          echo "üåê –î–µ–ø–ª–æ–π –Ω–∞ staging —Å—Ä–µ–¥—É..."
          echo "–°—Ä–µ–¥–∞: ${{ vars.ENVIRONMENT_NAME || 'staging' }}"
          echo "–í–µ—Ä—Å–∏—è: ${{ needs.setup.outputs.timestamp }}"
          sleep 3
          echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ staging –∑–∞–≤–µ—Ä—à–µ–Ω"
      
      - name: üìû –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        run: |
          echo "üì¢ –û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ..."
          echo "–î–µ–ø–ª–æ–π v${{ needs.setup.outputs.timestamp }} –Ω–∞ staging —É—Å–ø–µ—à–µ–Ω!"

  # –≠—Ç–∞–ø 6: –î–µ–ø–ª–æ–π –Ω–∞ production (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
  deploy-production:
    needs: [deploy-staging]  # ‚¨ÖÔ∏è –°–¢–†–ï–õ–û–ß–ö–ê –û–¢ deploy-staging –ö deploy-production
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –∏–∑ main –≤–µ—Ç–∫–∏
    
    steps:
      - name: ‚ö° –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
        run: |
          echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è production!"
          echo "–ó–∞–ø—É—â–µ–Ω–æ –∏–∑ –≤–µ—Ç–∫–∏: ${{ github.ref }}"
          echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
      
      - name: üöÄ Production –¥–µ–ø–ª–æ–π
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –¥–µ–ø–ª–æ–π –≤ production..."
          echo "–≠—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π! –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã."
          sleep 5
          echo "üéâ Production –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
      
      - name: üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        run: |
          echo "üìà –ü–û–õ–ù–´–ô –ö–û–ù–í–ï–ô–ï–† –í–´–ü–û–õ–ù–ï–ù"
          echo "=========================="
          echo "‚úÖ setup ‚Üí lint ‚Üí build ‚Üí test ‚Üí deploy-staging ‚Üí deploy-production"
          echo "üïê –í—Ä–µ–º—è: $(date)"
          echo "üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
